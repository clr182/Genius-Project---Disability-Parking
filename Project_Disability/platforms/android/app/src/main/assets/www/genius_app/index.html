<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="initial-scale=1.0, width=device-width" />
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <title>Main menu</title>

  <link rel="stylesheet" href="css/index.css">

  <script type="text/javascript" src="js/menu.js"></script>
      
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body> 

<div id="mySidenav" class="sidenav">
  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
  <a href="index.html" id="index">HOME</a>
  <a href="alarm.html" id="alarm" >Alarm</a>
  <a href="share.html" id="share">Share</a>
  <a href="contact.html" id="nurse">Contact nurse</a>
  <a href="new_place.html" id="place">Add new place</a>
</div>

<span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776;</span>

<!--<div style="position: relative; float: right">
    <div class="search-container">
    <form action="/action_page.php">
      <input type="text" placeholder="Search.." name="search" style="font-size: 20px">
      <button type="submit"><i class="fa fa-search" style="box-sizing: 30px"></i></button>
    </form>
  </div>
</div>-->

<div id="map"></div>

<script>
   var customLabel = {
    spot: {
        label: 'P'
    }
};

var map = null;
var lat1 = 0;
var lat2 = 0;
var lng1 = 0;
var lng2 = 0;

function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: new google.maps.LatLng(63.67419759459405, 22.705937792731675),
        zoom: 16,
        mapTypeId: google.maps.MapTypeId.ROADMAP});

        openSpotPreview();

        downloadUrl('GetNearestSpot.php', function(data) {
        var xml = data.responseXML;
        var markers = xml.documentElement.getElementsByTagName('marker');
        Array.prototype.forEach.call(markers, function(markerElem) {
            var id = markerElem.getAttribute('id');
            var name = markerElem.getAttribute('address');
            var address = markerElem.getAttribute('address');
            var image = markerElem.getAttribute('image');
            var distance = markerElem.getAttribute('distance');
            var point = new google.maps.LatLng(
                parseFloat(markerElem.getAttribute('lat')),
                parseFloat(markerElem.getAttribute('lng'))
            );
            var infowincontent = document.createElement('div');

            var img = document.createElement('img');
            img.src = image;
            img.style.cssText = "display:block;margin-left:auto;margin-right:auto;height:100px;width:100px;";
            infowincontent.appendChild(img);
            infowincontent.appendChild(document.createElement('br'));

            var strong = document.createElement('strong');
            strong.textContent = name;
            infowincontent.appendChild(strong);
            infowincontent.appendChild(document.createElement('br'));

            var text = document.createElement('text');
            text.textContent = point;
            infowincontent.appendChild(text);
            infowincontent.appendChild(document.createElement('br'));

            var dstnc = document.createElement('text');
            dstnc.textContent = Math.ceil(distance) + " meters away";
            infowincontent.appendChild(dstnc);
            infowincontent.appendChild(document.createElement('br'));

            var report_button = document.createElement('button');
            report_button.textContent = "Report";
            report_button.style.cssText = "display:block;margin-left:auto;margin-right:auto;";
            report_button.addEventListener('click', function() {
                reportSpot(id);
            });
            infowincontent.appendChild(report_button);

            

            var comments = document.createElement('table');
            comments.setAttribute("id", "comment_table_" + id);

            var row = document.createElement('tr');
            comments.appendChild(row);

            infowincontent.appendChild(comments);

            var icon = customLabel["spot"] || {};
            var marker = new google.maps.Marker({
                map: map,
                position: point,
                label: icon.label
            });
            marker.addListener('click', function() {
                infoWindow.setContent(infowincontent);
                infoWindow.open(map, marker);
            });
        });
    });

    // TODO: add way to only load points within the current view

    var infoWindow = new google.maps.InfoWindow;
}

function downloadUrl(url, callback) {
    var request = new XMLHttpRequest();

    request.onreadystatechange = function() {
        if(request.readyState == 4 && request.status == 200) {
            request.onreadystatechange = doNothing;
            callback(request, request.status);
        }
    };

    var position = map.getCenter();
    var latitude = position.lat();
    var longitude = position.lng();

    request.open('POST', url, true);
    request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    request.send("latitude=" + latitude + "&longitude=" + longitude);
}

function doNothing(){};

function reportSpot(pid) {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "ReportSpot.php", true);
    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhr.send("pid=" + pid);
}

function openSpotPreview(infoWindow, infowincontent, map, marker, id){
    var xhr = new XMLHttpRequest();

    xhr.onreadystatechange = function() {
        if(xhr.readyState == 4 && xhr.status == 200){
            xhr.onreadystatechange = doNothing;
        }
    }

    xhr.open("POST", "GetCommentsSpot.php", true);
    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhr.send("id=" + id);
}
 </script>
   
 <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFddZVW6vAvTEUKNQgoMlUIGYD6uzajIY&callback=initMap"
 type="text/javascript"></script>
 <script src="js/map.js" type="text/javascript"></script>
</body>
</html> 

